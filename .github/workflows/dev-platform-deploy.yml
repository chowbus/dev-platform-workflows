name: Deploy via dev-platform

# ç®€å•æµ‹è¯• workflow - å†…è”ç‰ˆæœ¬ï¼ˆä¸ä¾èµ– reusable workflowï¼‰

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: string
      bucket_name:
        description: 'S3 bucket name'
        required: true
        type: string
      callback_url:
        description: 'Deployment callback URL'
        required: false
        type: string
      cloudfront_id:
        description: 'CloudFront Distribution ID'
        required: false
        type: string
      git_ref:
        description: 'Git branch/tag to deploy'
        required: false
        type: string
        default: 'main'
      iteration_id:
        description: 'Iteration ID'
        required: false
        type: string
      iteration_name:
        description: 'Iteration name'
        required: false
        type: string
      version:
        description: 'Version number'
        required: false
        type: string

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    # æµ‹è¯•é˜¶æ®µä¸éœ€è¦å®¡æ‰¹
    # environment: deploy-${{ inputs.environment }}

    steps:
      - name: ðŸ“‹ Deployment Info
        run: |
          echo "ðŸš€ Starting deployment..."
          echo "Environment: ${{ inputs.environment }}"
          echo "Bucket: ${{ inputs.bucket_name }}"
          echo "Git Ref: ${{ inputs.git_ref }}"
          echo "Iteration: ${{ inputs.iteration_name }} (${{ inputs.iteration_id }})"
          echo "Version: ${{ inputs.version }}"

      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.git_ref }}

      - name: ðŸ—ï¸ Build
        run: |
          echo "ðŸ“¦ Building project..."
          mkdir -p build
          cp index.html build/
          echo "âœ… Build completed"
          ls -la build/

      - name: ðŸ”‘ Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_STAGING_CI }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_STAGING_CI }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: ðŸ“¤ Deploy to S3
        run: |
          if [ "${{ inputs.environment }}" = "production" ]; then
            S3_PATH="s3://${{ inputs.bucket_name }}.chowbus.com/"
          else
            S3_PATH="s3://${{ inputs.bucket_name }}-${{ inputs.environment }}.chowbus.com/"
          fi
          
          echo "ðŸ“¤ Deploying to: $S3_PATH"
          aws s3 sync build/ "$S3_PATH" --delete
          echo "âœ… S3 deployment completed"

      - name: ðŸ”„ Invalidate CloudFront Cache
        if: inputs.cloudfront_id != ''
        run: |
          echo "ðŸ”„ Invalidating CloudFront: ${{ inputs.cloudfront_id }}"
          aws cloudfront create-invalidation \
            --distribution-id "${{ inputs.cloudfront_id }}" \
            --paths "/*"

      - name: ðŸ“ž Send Callback (Success)
        if: success() && inputs.callback_url != ''
        run: |
          if [ "${{ inputs.environment }}" = "production" ]; then
            DEPLOY_URL="https://${{ inputs.bucket_name }}.chowbus.com"
          else
            DEPLOY_URL="https://${{ inputs.bucket_name }}-${{ inputs.environment }}.chowbus.com"
          fi
          
          curl -X POST "${{ inputs.callback_url }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"status\": \"success\",
              \"environment\": \"${{ inputs.environment }}\",
              \"deploymentId\": \"${{ github.run_id }}\",
              \"deploymentUrl\": \"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\",
              \"deployedUrl\": \"$DEPLOY_URL\",
              \"iterationId\": \"${{ inputs.iteration_id }}\",
              \"version\": \"${{ inputs.version }}\"
            }" || echo "âš ï¸ Callback failed"

      - name: ðŸ“ž Send Callback (Failure)
        if: failure() && inputs.callback_url != ''
        run: |
          curl -X POST "${{ inputs.callback_url }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"status\": \"failure\",
              \"environment\": \"${{ inputs.environment }}\",
              \"deploymentId\": \"${{ github.run_id }}\",
              \"deploymentUrl\": \"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\",
              \"iterationId\": \"${{ inputs.iteration_id }}\",
              \"version\": \"${{ inputs.version }}\",
              \"error\": \"Deployment failed\"
            }" || echo "âš ï¸ Callback failed"

      - name: ðŸ“Š Summary
        if: always()
        run: |
          echo "## ðŸ“Š Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Bucket**: ${{ inputs.bucket_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
