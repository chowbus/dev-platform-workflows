name: Web Deploy Template (Reusable)

on:
  workflow_call:
    inputs:
      environment:
        description: 'Target environment (staging-01, staging-02, staging-03, production)'
        required: true
        type: string
      bucket_name:
        description: 'S3 bucket name (without environment suffix)'
        required: true
        type: string
      node_version:
        description: 'Node.js version'
        required: false
        type: string
        default: "16.18"
      callback_url:
        description: 'Deployment callback URL'
        required: false
        type: string
        default: ""
      cloudfront_id:
        description: 'CloudFront Distribution ID (optional)'
        required: false
        type: string
        default: ""
      git_ref:
        description: 'Git branch/tag to checkout and deploy'
        required: false
        type: string
        default: "main"
      custom_build_cmd:
        description: 'Custom build command to run after build (optional)'
        required: false
        type: string
        default: ""
      build_arg_rename:
        description: 'Environment variables to inject from secrets (space-separated)'
        required: false
        type: string
        default: ""
      s3_prefix:
        description: 'S3 path prefix (optional)'
        required: false
        type: string
        default: ""
      iteration_id:
        description: 'Iteration ID (for tracking)'
        required: false
        type: string
        default: ""
      iteration_name:
        description: 'Iteration name (for tracking)'
        required: false
        type: string
        default: ""
      version:
        description: 'Version number (for tracking)'
        required: false
        type: string
        default: ""
      build_command:
        description: 'NPM build command name (e.g., build, build_staging)'
        required: false
        type: string
        default: "build"
      build_output_dir:
        description: 'Build output directory'
        required: false
        type: string
        default: "dist"
      package_manager:
        description: 'Package manager to use (auto, npm, yarn, pnpm). Auto will detect from lock file.'
        required: false
        type: string
        default: "auto"
      aws_region:
        description: 'AWS Region'
        required: false
        type: string
        default: "us-east-1"
      dry_run:
        description: 'Dry run mode - skip actual AWS deployment (for testing)'
        required: false
        type: boolean
        default: false
    secrets:
      AWS_ACCESS_KEY_ID_STAGING_CI:
        description: 'AWS Access Key ID for Staging'
        required: false
      AWS_SECRET_ACCESS_KEY_STAGING_CI:
        description: 'AWS Secret Access Key for Staging'
        required: false
      AWS_ACCESS_KEY_ID_PRODUCTION_CI:
        description: 'AWS Access Key ID for Production'
        required: false
      AWS_SECRET_ACCESS_KEY_PRODUCTION_CI:
        description: 'AWS Secret Access Key for Production'
        required: false
      AWS_ACCESS_KEY_ID_PROD_CI:
        description: 'AWS Access Key ID for Production (alias)'
        required: false
      AWS_SECRET_ACCESS_KEY_PROD_CI:
        description: 'AWS Secret Access Key for Production (alias)'
        required: false
      AWS_REGION:
        description: 'AWS Region'
        required: false
      OAUTH_GITHUB_TOKEN:
        description: 'GitHub OAuth Token'
        required: false

env:
  GITHUB_TOKEN: ${{ secrets.OAUTH_GITHUB_TOKEN }}
  BUILD_ENV: ${{ inputs.environment }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: deploy-${{ inputs.environment }}
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.git_ref }}

      - name: üîç Detect Package Manager
        id: detect-pm
        run: |
          # Â¶ÇÊûú‰º†ÂÖ•‰∫Ü package_manager ÂèÇÊï∞‰∏î‰∏çÊòØ autoÔºå‰ΩøÁî®‰º†ÂÖ•ÁöÑÂÄº
          if [ "${{ inputs.package_manager }}" != "auto" ] && [ -n "${{ inputs.package_manager }}" ]; then
            echo "PACKAGE_MANAGER=${{ inputs.package_manager }}" >> $GITHUB_OUTPUT
            echo "HAS_LOCK_FILE=true" >> $GITHUB_OUTPUT
            echo "üì¶ Using specified package manager: ${{ inputs.package_manager }}"
          # Âê¶ÂàôËá™Âä®Ê£ÄÊµã
          elif [ -f "yarn.lock" ]; then
            echo "PACKAGE_MANAGER=yarn" >> $GITHUB_OUTPUT
            echo "HAS_LOCK_FILE=true" >> $GITHUB_OUTPUT
            echo "üì¶ Detected yarn.lock, using yarn"
          elif [ -f "package-lock.json" ]; then
            echo "PACKAGE_MANAGER=npm" >> $GITHUB_OUTPUT
            echo "HAS_LOCK_FILE=true" >> $GITHUB_OUTPUT
            echo "üì¶ Detected package-lock.json, using npm"
          elif [ -f "pnpm-lock.yaml" ]; then
            echo "PACKAGE_MANAGER=pnpm" >> $GITHUB_OUTPUT
            echo "HAS_LOCK_FILE=true" >> $GITHUB_OUTPUT
            echo "üì¶ Detected pnpm-lock.yaml, using pnpm"
          else
            echo "PACKAGE_MANAGER=npm" >> $GITHUB_OUTPUT
            echo "HAS_LOCK_FILE=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è No lock file found, defaulting to npm (no cache)"
          fi

      - name: üîß Setup Node Environment (with cache)
        if: steps.detect-pm.outputs.HAS_LOCK_FILE == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version }}
          cache: ${{ steps.detect-pm.outputs.PACKAGE_MANAGER }}

      - name: üîß Setup Node Environment (no cache)
        if: steps.detect-pm.outputs.HAS_LOCK_FILE != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version }}

      - name: üì¶ Install Dependencies (Yarn)
        if: steps.detect-pm.outputs.PACKAGE_MANAGER == 'yarn'
        run: |
          yarn install --frozen-lockfile
          echo "CHECKSUM=$(shasum yarn.lock| awk '{print $1}')" >> $GITHUB_ENV

      - name: üì¶ Install Dependencies (NPM)
        if: steps.detect-pm.outputs.PACKAGE_MANAGER == 'npm'
        run: |
          npm ci
          echo "CHECKSUM=$(shasum package-lock.json 2>/dev/null | awk '{print $1}' || echo 'no-lock')" >> $GITHUB_ENV

      - name: üì¶ Install Dependencies (PNPM)
        if: steps.detect-pm.outputs.PACKAGE_MANAGER == 'pnpm'
        run: |
          npm install -g pnpm
          pnpm install --frozen-lockfile
          echo "CHECKSUM=$(shasum pnpm-lock.yaml| awk '{print $1}')" >> $GITHUB_ENV

      - name: üîê Initialize Secrets
        env:
          SECRETS_CONTEXT: ${{ toJson(secrets) }}
        run: |
          secret_list=$(jq -r 'to_entries[] | select (.key != "ENG_PRIVATE_KEY" and .key != "GITHUB_TOKEN") | ("\(.key)=\(.value)")' <<< $SECRETS_CONTEXT)
          for s in $secret_list; do
            echo $s >> $GITHUB_ENV
          done

      - name: üîê Inject Secrets to .env
        if: inputs.build_arg_rename != ''
        run: |
          # Inject GitHub Secrets to .env file
          for arg in ${{ inputs.build_arg_rename }}; do
            target_env_var="${{ inputs.environment }}"
            target_env_var_name="${arg}_${target_env_var/-/_}"
            target_arg=${target_env_var_name^^}
            echo "" >> .env.${{ inputs.environment }}
            echo "$arg=$(printenv ${target_arg})" >> .env.${{ inputs.environment }}
          done
          
          # Show injected variables (masked)
          echo "üìù Injected environment variables:"
          cat .env.${{ inputs.environment }} | sed 's/\(.*=\).*/\1***/' || true

      - name: üèóÔ∏è Build Application
        run: |
          export NODE_OPTIONS=--openssl-legacy-provider
          npm run ${{ inputs.build_command }}
        env:
          CI: true

      - name: üî® Custom Build Command
        if: inputs.custom_build_cmd != ''
        run: |
          ${{ inputs.custom_build_cmd }}

      - name: üìä Verify Build Output
        run: |
          if [ ! -d "${{ inputs.build_output_dir }}" ]; then
            echo "‚ùå Build output directory '${{ inputs.build_output_dir }}' not found"
            exit 1
          fi
          
          echo "‚úÖ Build output directory exists"
          echo "üìÅ Build output contents:"
          ls -lah ${{ inputs.build_output_dir }}/ || true
          
          # Calculate build size
          BUILD_SIZE=$(du -sh ${{ inputs.build_output_dir }} | cut -f1)
          echo "üì¶ Build size: $BUILD_SIZE"

      - name: üîë Configure AWS Credentials (Staging)
        if: inputs.environment != 'production' && !inputs.dry_run
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_STAGING_CI }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_STAGING_CI }}
          aws-region: ${{ inputs.aws_region || secrets.AWS_REGION || 'us-east-1' }}

      - name: üîë Configure AWS Credentials (Production)
        if: inputs.environment == 'production' && !inputs.dry_run
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_PROD_CI }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_PROD_CI }}
          aws-region: ${{ inputs.aws_region || secrets.AWS_REGION || 'us-east-1' }}

      - name: üß™ Dry Run - Simulate Deployment
        if: inputs.dry_run
        run: |
          # Construct S3 path
          if [ "${{ inputs.environment }}" = "production" ]; then
            S3_PATH="s3://${{ inputs.bucket_name }}.chowbus.com/"
          else
            S3_PATH="s3://${{ inputs.bucket_name }}-${{ inputs.environment }}.chowbus.com/"
          fi
          
          # Add prefix if specified
          if [ -n "${{ inputs.s3_prefix }}" ]; then
            S3_PATH="${S3_PATH}${{ inputs.s3_prefix }}/"
          fi
          
          echo "üß™ DRY RUN MODE - No actual deployment"
          echo "üìç Environment: ${{ inputs.environment }}"
          echo "üì¶ Build output: ${{ inputs.build_output_dir }}/"
          echo "üéØ Would deploy to: $S3_PATH"
          echo "üîß Build command: ${{ inputs.build_command }}"
          
          if [ -n "${{ inputs.cloudfront_id }}" ]; then
            echo "üîÑ Would invalidate CloudFront: ${{ inputs.cloudfront_id }}"
          fi
          
          echo "‚úÖ Dry run completed successfully"

      - name: üì§ Deploy to S3
        if: '!inputs.dry_run'
        run: |
          # Construct S3 path
          if [ "${{ inputs.environment }}" = "production" ]; then
            S3_PATH="s3://${{ inputs.bucket_name }}.chowbus.com/"
          else
            S3_PATH="s3://${{ inputs.bucket_name }}-${{ inputs.environment }}.chowbus.com/"
          fi
          
          # Add prefix if specified
          if [ -n "${{ inputs.s3_prefix }}" ]; then
            S3_PATH="${S3_PATH}${{ inputs.s3_prefix }}/"
          fi
          
          echo "üì§ Deploying to: $S3_PATH"
          
          # Sync to S3
          aws s3 sync ${{ inputs.build_output_dir }}/ "$S3_PATH" --delete
          
          echo "‚úÖ S3 deployment completed"

      - name: üîÑ Invalidate CloudFront Cache
        if: inputs.cloudfront_id != '' && !inputs.dry_run
        run: |
          CLOUDFRONT_ID="${{ inputs.cloudfront_id }}"
          
          # Construct invalidation path
          if [ -n "${{ inputs.s3_prefix }}" ]; then
            INVALIDATION_PATH="/${{ inputs.s3_prefix }}/*"
          else
            INVALIDATION_PATH="/*"
          fi
          
          echo "üîÑ Invalidating CloudFront distribution: $CLOUDFRONT_ID"
          echo "üìÅ Invalidation path: $INVALIDATION_PATH"
          
          INVALIDATION_ID=$(aws cloudfront create-invalidation \
            --distribution-id "$CLOUDFRONT_ID" \
            --paths "$INVALIDATION_PATH" \
            --query 'Invalidation.Id' \
            --output text)
          
          echo "‚úÖ CloudFront invalidation created: $INVALIDATION_ID"

      - name: üè• Health Check
        if: always()
        run: |
          # Construct health check URL
          if [ "${{ inputs.environment }}" = "production" ]; then
            HEALTH_URL="https://${{ inputs.bucket_name }}.chowbus.com"
          else
            HEALTH_URL="https://${{ inputs.bucket_name }}-${{ inputs.environment }}.chowbus.com"
          fi
          
          if [ -n "${{ inputs.s3_prefix }}" ]; then
            HEALTH_URL="${HEALTH_URL}/${{ inputs.s3_prefix }}"
          fi
          
          echo "üè• Health checking: $HEALTH_URL"
          
          MAX_RETRIES=10
          RETRY_DELAY=5
          
          for i in $(seq 1 $MAX_RETRIES); do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_URL" || echo "000")
            
            if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "304" ]; then
              echo "‚úÖ Health check passed (HTTP $HTTP_CODE)"
              exit 0
            fi
            
            echo "‚è≥ Attempt $i/$MAX_RETRIES: HTTP $HTTP_CODE, retrying in ${RETRY_DELAY}s..."
            sleep $RETRY_DELAY
          done
          
          echo "‚ö†Ô∏è  Health check did not pass after $MAX_RETRIES attempts"
          # Don't fail the workflow, just warn
          exit 0

      - name: üìû Send Deployment Callback (Success)
        if: success() && inputs.callback_url != ''
        run: |
          CALLBACK_URL="${{ inputs.callback_url }}"
          
          # Construct deployment URL
          if [ "${{ inputs.environment }}" = "production" ]; then
            DEPLOY_URL="https://${{ inputs.bucket_name }}.chowbus.com"
          else
            DEPLOY_URL="https://${{ inputs.bucket_name }}-${{ inputs.environment }}.chowbus.com"
          fi
          
          if [ -n "${{ inputs.s3_prefix }}" ]; then
            DEPLOY_URL="${DEPLOY_URL}/${{ inputs.s3_prefix }}"
          fi
          
          PAYLOAD=$(cat <<EOF
          {
            "status": "success",
            "environment": "${{ inputs.environment }}",
            "deploymentId": "${{ github.run_id }}",
            "deploymentUrl": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}",
            "deployedUrl": "$DEPLOY_URL",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "iterationId": "${{ inputs.iteration_id }}",
            "iterationName": "${{ inputs.iteration_name }}",
            "version": "${{ inputs.version }}"
          }
          EOF
          )
          
          echo "üìû Sending success callback to: $CALLBACK_URL"
          
          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD" \
            --max-time 10 \
            --retry 3 \
            || echo "‚ö†Ô∏è  Callback failed, but deployment succeeded"

      - name: üìû Send Deployment Callback (Failure)
        if: failure() && inputs.callback_url != ''
        run: |
          CALLBACK_URL="${{ inputs.callback_url }}"
          
          PAYLOAD=$(cat <<EOF
          {
            "status": "failure",
            "environment": "${{ inputs.environment }}",
            "deploymentId": "${{ github.run_id }}",
            "deploymentUrl": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "error": "Deployment failed, check GitHub Actions logs for details",
            "iterationId": "${{ inputs.iteration_id }}",
            "iterationName": "${{ inputs.iteration_name }}",
            "version": "${{ inputs.version }}"
          }
          EOF
          )
          
          echo "üìû Sending failure callback to: $CALLBACK_URL"
          
          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD" \
            --max-time 10 \
            --retry 3 \
            || echo "‚ö†Ô∏è  Callback failed"

      - name: ÔøΩ Send Deployment Callback (Cancelled)
        if: cancelled() && inputs.callback_url != ''
        run: |
          CALLBACK_URL="${{ inputs.callback_url }}"
          
          PAYLOAD=$(cat <<EOF
          {
            "status": "cancelled",
            "environment": "${{ inputs.environment }}",
            "deploymentId": "${{ github.run_id }}",
            "deploymentUrl": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "error": "Deployment was cancelled",
            "iterationId": "${{ inputs.iteration_id }}",
            "iterationName": "${{ inputs.iteration_name }}",
            "version": "${{ inputs.version }}"
          }
          EOF
          )
          
          echo "üìû Sending cancellation callback to: $CALLBACK_URL"
          
          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD" \
            --max-time 10 \
            --retry 3 \
            || echo "‚ö†Ô∏è  Callback failed"

      - name: ÔøΩüìä Deployment Summary
        if: always()
        run: |
          echo "## üìä Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Bucket**: ${{ inputs.bucket_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Node Version**: ${{ inputs.node_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ inputs.environment }}" = "production" ]; then
            DEPLOY_URL="https://${{ inputs.bucket_name }}.chowbus.com"
          else
            DEPLOY_URL="https://${{ inputs.bucket_name }}-${{ inputs.environment }}.chowbus.com"
          fi
          
          if [ -n "${{ inputs.s3_prefix }}" ]; then
            DEPLOY_URL="${DEPLOY_URL}/${{ inputs.s3_prefix }}"
          fi
          
          echo "- **Deployed URL**: [$DEPLOY_URL]($DEPLOY_URL)" >> $GITHUB_STEP_SUMMARY
